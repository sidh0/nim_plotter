function [binnedIgfs,binnedRates] = run_igf(NimCell,NimFit,trialMasks,optStruct)
    % Computes the 
    %
    % Usage: [runDxs,tc,vars,allResps] = ...
    % run_forward_correlation(data,<runDur>,<windowSize>,<lag>,<triggerOnce>,<trialMask>)
    %
    % NimCell : NimCell struct
    % 
    % NimModel : The fitted NIM object
    % 
    % trialMasks : cell array containing logical arrays denoting the
    % triggers for each condition
    %
    % windowSize (optional) : size of the forward window to run forward
    % correlation; at 10 ms resolution, windowSize=15 would mean 150 ms
    % window).
    %
    % lag (optional) : An optional delay (e.g., 2 would delay the beginning
    % of the window to 20 ms after the frame onset)
    %    
                
    if ~isprop(NimFit,'stim_params');
        if isfield(NimFit,'NimFit');
            NimFit = NimFit.NimFit;
        else
            error('Something funny here... Wrong/no struct passed?');
        end
    end
        
        
    nBins = 11; % number of bins
    
    windowSize = 3;
    
    lag = 4;
    
    if nargin > 4
        unpackStruct(optStruct);
    end
    
        
        
    
        elseif isempty(lag);
    
    end
    
    if 
    
    
    %% Create and compute the IGF values
    params_stim = NimFit.stim_params;

    Xstim = NIM.create_time_embedding(NimCell.stim,params_stim);
    
    rObs = get_rate(NimCell);
    
    [~,~,mod_internals] = NimFit.eval_model(rObs,{Xstim});
    
    G = mod_internals.G;
    
    %% Group according to the trialMask
    igfs = cellfun(@(trialMask) group_data(G,trialMask,windowSize,lag),trialMasks,'uniformoutput',false);
    
    rates = cellfun(@(trialMask) group_data(rObs,trialMask,windowSize,lag),trialMasks,'uniformoutput',false);
        
    %bins = prctile(G,linspace(0,1,nBins));
        
    %% Finally bin the databased on igf values
    [binnedIgfs,binnedRates] = cellfun(@(igf,rate)run_binning(igf,rate,nBins),igfs,rates,'uniformoutput',false);
    
        
end

function [binnedIgf,binnedRate] = run_binning(igf,rate,nBins)

    edges = linspace(0,100,nBins+1);
    edges = edges(1:end-1);
    bins = prctile(igf,edges);
    
    [~,~,idx] = histcounts(igf,bins);    
    
    binnedRate = arrayfun(@(k)(mean(rate(idx==k))),0:(nBins-1));
    binnedIgf = arrayfun(@(k)(mean(igf(idx==k))),0:(nBins-1));

end


function igf = group_data(G,trialMask,windowSize,lag)

    trialIdx = find(trialMask);
    
    igf = zeros(1,length(trialIdx)*windowSize);
    
    for k = 1:length(trialIdx);        
        
        start = trialIdx(k)+lag;
        
        stop = start+windowSize-1;
        
        igfStart = (k-1)*windowSize + 1;
        
        igfStop = igfStart+windowSize-1;
        
        igf(igfStart:igfStop) = G(start:stop);
        
    end
        

end